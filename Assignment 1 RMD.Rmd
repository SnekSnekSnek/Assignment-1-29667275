---
title: "Assignment 1"
output: html_document
date: "2024-05-13"
---
```{r,include=FALSE}
#Loading libraries
library("dplyr")
library(tidyverse)
library(grid)
library("knitr")
library("usethis")
library(ggplot2)
```
## Research question

In this report I aim to investigate how the distribution of types of alcohol consumed over time across different countries has changed. In particular I wish to explore how the trends have overall changed and which countries differ from this trend.
  
```{r,echo=FALSE}
#Load the data
data_alcohol <- read.csv("Data/alcohol-by-type-1890.csv")
#Remove 'CODE' as this is an extraneous variable
data_alcohol = subset(data_alcohol, select = -c(2))
data_alcohol2 = data_alcohol
#Rename some variables for ease of reading
names(data_alcohol2) <- c("Country", "Year", "SpiritsPercentage","BeerPercentage","WinePercentage")

```

## Data Introduction

This dataset tracks the proportion of different types of alcohol over time across a range of countries. The data itself is derived from annual databases on wine, compiled by the university of Adelaide.

The variables tracking beer, wine and spirits % represents how much each type of beverage made of total alcohol consumption. The total consumption is based off these 3 drinks so does not include other types such as cider. Year and State variables simply track where and when each observation was made. 

[Data can be found here](https://ourworldindata.org/grapher/alcohol-by-type-1890?tab=table&country=~FRA)

Below is a table displaying the data for just Australia, with the renamed variables in use. A separate table providing the original variable names is also provided to provide clarity.
```{r,echo=FALSE}
table_alcohol <- head(data_alcohol2,5)
knitr::kable(table_alcohol, 
             caption = "Alcohol consumption by type, Australia",
             digits = 2)

table_alcohol <- head(data_alcohol,5)
knitr::kable(table_alcohol, 
             caption = "Alcohol consumption by type, Australia",
             digits = 2)
```

## Data Set Description

```{r,echo=FALSE}
cat("\nThe number of observations is",nrow(data_alcohol2) , "and the number of variables is", ncol(data_alcohol2))

cat("\nthe number of numerical variables",length(select_if(data_alcohol2,is.numeric)), "and the number of categorical variables is",length(select_if(data_alcohol2,is.character)))

cat("\nCode used to generate this printout is below")

knitr::include_graphics("images/Code.PNG")

#For some reason the length of the output isn't consistent. This is close to 2 rows, if I set the length to 2 we get many more values for the int variables.

#USE UNGROUP() TO FIX THE ISSUE, THEN REDO SCREENSHOT

cat("\nHere's the first few rows of the data presented such that you can see the type of variable.")
str(data_alcohol2,vec.len=1)
```


## Data set summary

```{r,echo=FALSE}
group_by(data_alcohol2)

data_alcohol_grouped = data_alcohol2 %>% group_by(Year) 

data_alcohol_grouped2 = data_alcohol_grouped %>% summarise_at(.vars = vars(BeerPercentage,WinePercentage),
               .funs = c(mean="mean"))

data_alcohol_grouped = data_alcohol_grouped %>% summarise_at(.vars = vars(BeerPercentage,WinePercentage),
               .funs = c(var="var"))

data_alcohol_grouped$BeerPercentage_mean=data_alcohol_grouped2$BeerPercentage_mean
data_alcohol_grouped$WinePercentage_mean=data_alcohol_grouped2$WinePercentage_mean

kable(data_alcohol_grouped, caption = "Mean and variance of beer and wine across all countries over time.")
```

This data summary suggests that across all countries, the proportion of beer drunk rose over time and peaked in 1964, while wine rose, dipped in 1964, then continued to rise to its current record proportion. Both wine and beer saw a **sharp** decline in variance over time, indicating many countries converging towards a similar proportion of beer and wine drunk.




   
```{r,echo=FALSE, fig.width=10,fig.height=11}

#Doing the mean for overall is highly uninformative, so we want some method to display multiple countries at once - even if ugly.

data_alcohol_graph <- data_alcohol2 %>% pivot_longer(cols = c(BeerPercentage, WinePercentage,  SpiritsPercentage),
                           names_to = "Drink_Type")

ggplot(data = data_alcohol_graph, aes(x = factor(Year))) +
  geom_point(aes(y=value,col=Drink_Type)) + 
  facet_wrap(~Country) + 
  labs(caption = "This simple graph allows an easy visualisation of trends over time. One graph is provided for each country. ",color="Type Of Drink\n") +
  scale_color_manual(labels = c("Beer", "Wine","Spirits"),values = c("blue", "red","black")) +
  xlab('Year') +
  ylab("Proportion Drunk")
```

### Observations

* *Wine saw an increase in many countries, Beer generally rose then dipped then rose again, spirits generally dipped.*
* *Outlier data is the fall of wine in france and switzerland, the increase of beer in finland, and the increase of spirits in the UK.*

## Conclusions

This provides a cursory overview of the data. The summary and the graph help describe the general trends across many countries. The graph also allows us to identify the listed outliers. These graphs also show the large variance in beer and wine in earlier years that was noted earlier, as well as a similar pattern for spirits. Unfortunately, many countries lack data points for some years, such as Norway and Finland. This makes proper analysis of the trend difficult.

Overall I have identified patterns in the overall trends, with wine increasing, beer rising, falling, then rising again and spirits dipping. I also have identified outlier countries which could form a basis for further analysis.


## Expansion

We can focus on the outliers. Step 1 can be to make a table showing the means of each drink in each year, and then the difference of each country next to it.

```{r,include = FALSE}
group_by(data_alcohol2)

data_alcohol_grouped = data_alcohol2 %>% group_by(Year) 

data_alcohol_grouped3 = data_alcohol_grouped %>% summarise_at(.vars = vars(BeerPercentage,WinePercentage,SpiritsPercentage),
               .funs = c(mean="mean"))


data_alcohol_grouped=left_join(data_alcohol_grouped, data_alcohol_grouped3, by = 'Year')



data_alcohol_grouped$diffWine <- data_alcohol_grouped$WinePercentage - data_alcohol_grouped$WinePercentage_mean
data_alcohol_grouped$diffBeer <- data_alcohol_grouped$BeerPercentage - data_alcohol_grouped$WinePercentage_mean
data_alcohol_grouped$diffSpirits <- data_alcohol_grouped$SpiritsPercentage - data_alcohol_grouped$WinePercentage_mean

#Now we want to decipher where the divergences from the mean are largest.

arrange(data_alcohol_grouped, by_group = diffWine)
#This seems to work but we need to ungroup the dataframe
#strat seems to be make a separate vector/df that's hopefully not grouped


ungroup_df = ungroup(ungroup_df)

#Make ddataframes out of these top 5
Wine_Deviants <- top_n(ungroup_df,5,diffWine)
arrange(data_alcohol_grouped, by_group = diffBeer)
Beer_Deviants <- top_n(ungroup_df,5,diffBeer)
arrange(data_alcohol_grouped, by_group = diffSpirits)
Spirits_Deviants <- top_n(ungroup_df,5,diffSpirits)

#Remove extraneous columns
Wine_Deviants <- Wine_Deviants[ -c(3:8,10,11) ]
Beer_Deviants <- Beer_Deviants[ -c(3:9,11) ]
Spirits_Deviants <- Spirits_Deviants[ -c(3:10) ]

#Make country vector names more comprehensible for final analsysis
names(Wine_Deviants) <- c("CountryWine", "Year", "DiffWine")
names(Beer_Deviants) <- c("CountryBeer", "Year", "DiffBeer")
names(Spirits_Deviants) <- c("CountrySpirits", "Year", "DiffSpirits")


#Select the rows from our initial data table that we found had the highest variance
#This solution is a bit poor as it only works with my knowledge of what the values for the highest variance entries already are. A more wise approach would automate this by pulling the values from the 'Spirits/Wine/Beer_Deviants" tables directly. This still works fine for my purposes however.

WineDiff1 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'France' & data_alcohol_grouped$Year == 1964, ]
WineDiff2 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Italy' & data_alcohol_grouped$Year == 1890, ]
WineDiff3 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Italy' & data_alcohol_grouped$Year == 1929, ]
WineDiff4 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Italy' & data_alcohol_grouped$Year == 1964, ]
WineDiff5 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Italy' & data_alcohol_grouped$Year == 1984, ]

#We remove extraneous values. For example we eventually want a list of the 5 entries with the higest deviation from the mean in wine consumption, so we remove values relating to beer and spirits for clarity.

WineDiff1[c(3,4,6,8,10,11)] = NA
WineDiff2[c(3,4,6,8,10,11)] = NA
WineDiff3[c(3,4,6,8,10,11)] = NA
WineDiff4[c(3,4,6,8,10,11)] = NA
WineDiff5[c(3,4,6,8,10,11)] = NA

BeerDiff1 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Australia' & data_alcohol_grouped$Year == 1964, ]
BeerDiff2 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Belgium' & data_alcohol_grouped$Year == 1964, ]
BeerDiff3 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Denmark' & data_alcohol_grouped$Year == 1964, ]
BeerDiff4 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Denmark' & data_alcohol_grouped$Year == 1964, ]
BeerDiff5 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'United Kingdom' & data_alcohol_grouped$Year == 1964, ]

BeerDiff1[c(3,5,7,8,9,11)] = NA
BeerDiff2[c(3,5,7,8,9,11)] = NA
BeerDiff3[c(3,5,7,8,9,11)] = NA
BeerDiff4[c(3,5,7,8,9,11)] = NA
BeerDiff5[c(3,5,7,8,9,11)] = NA

SpiritsDiff1 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Finland' & data_alcohol_grouped$Year == 1964, ]
SpiritsDiff2 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Japan' & data_alcohol_grouped$Year == 1964, ]
SpiritsDiff3 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Japan' & data_alcohol_grouped$Year == 1984, ]
SpiritsDiff4 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Netherlands' & data_alcohol_grouped$Year == 1890, ]
SpiritsDiff5 <- data_alcohol_grouped[data_alcohol_grouped$Country == 'Norway' & data_alcohol_grouped$Year == 1964, ]

SpiritsDiff1[c(4:7,9,10)] = NA
SpiritsDiff2[c(4:7,9,10)] = NA
SpiritsDiff3[c(4:7,9,10)] = NA
SpiritsDiff4[c(4:7,9,10)] = NA
SpiritsDiff5[c(4:7,9,10)] = NA

FinalDataframe <- bind_rows(WineDiff1,WineDiff2,WineDiff3,WineDiff4,WineDiff5,BeerDiff1,BeerDiff2,BeerDiff3,BeerDiff4,BeerDiff5,SpiritsDiff1,SpiritsDiff2,SpiritsDiff3,SpiritsDiff4,SpiritsDiff5)
```

```{r}
FinalDataframe
```